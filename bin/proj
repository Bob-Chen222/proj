#!/usr/bin/env python3

from pathlib import Path
from typing import Any
import sys
import subprocess
import os
import shutil
import importlib
import multiprocessing

DIR = Path(__file__).resolve().parent

import sys
sys.path.append(str(DIR.parent / 'lib'))
import lockshaw_config as lockshaw
importlib.reload(lockshaw)

def main_root(args: Any) -> None:
    config_root = lockshaw.find_config_root(args.path)
    if config_root is not None:
        print(config_root)
    else:
        print('ERROR: Could not find config root', file=sys.stderr)
        print('Exiting unsuccessfully...', file=sys.stderr)
        exit(1)

def main_cmake(args: Any) -> None:
    config = lockshaw.get_config(args.path)
    assert config is not None
    if args.force:
        shutil.rmtree(config.build_dir)
    config.build_dir.mkdir(exist_ok=True, parents=True)
    cmake_args = [f'-D{k}={v}' for k, v in config.cmake_flags.items()]
    subprocess.check_call([
        'cmake',
        *cmake_args,
        '..',
    ], stderr=sys.stdout, cwd=config.build_dir, env=os.environ, shell=config.cmake_require_shell)

    with (config.base / 'compile_commands.json').open('w') as f:
        subprocess.check_call([
            'compdb',
            '-p',
            '.',
            'list',
        ], stdout=f, cwd=config.build_dir, env=os.environ)

def main_build(args: Any) -> None:
    config = lockshaw.get_config(args.path)
    assert config is not None
    subprocess.check_call([
        'make', '-j', str(args.jobs), *config.build_targets,
    ], env={
        **os.environ, 
        'CCACHE_BASEDIR': str(DIR.parent.parent.parent),
        **({'VERBOSE': '1'} if args.verbose else {})
    }, stderr=sys.stdout, cwd=config.build_dir)

def main_test(args: Any) -> None:
    config = lockshaw.get_config(args.path)
    assert config is not None
    subprocess.check_call([
        'make', '-j', str(args.jobs), *lockshaw.get_config(args.path).test_targets,
    ], env={
        **os.environ, 
        'CCACHE_BASEDIR': str(DIR.parent.parent.parent),
        **({'VERBOSE': '1'} if args.verbose else {})
    }, stderr=sys.stdout, cwd=config.build_dir)
    target_regex = '^' + '|'.join(config.test_targets) + '$'
    subprocess.run([
        'ctest', 
        '--progress',
        '--output-on-failure',
        '-L',
        target_regex,
    ], stderr=sys.stdout, cwd=config.build_dir, env=os.environ)

if __name__ == '__main__':
    import argparse 

    p = argparse.ArgumentParser()
    subparsers = p.add_subparsers()

    root_p = subparsers.add_parser('root')
    root_p.set_defaults(func=main_root)
    root_p.add_argument('--path', '-p', type=Path, default=Path.cwd())

    test_p = subparsers.add_parser('test')
    test_p.set_defaults(func=main_test)
    test_p.add_argument('--path', '-p', type=Path, default=Path.cwd())
    test_p.add_argument('--verbose', '-v', action='store_true')
    test_p.add_argument('--jobs', '-j', type=int, default=multiprocessing.cpu_count())

    build_p = subparsers.add_parser('build')
    build_p.set_defaults(func=main_build)
    build_p.add_argument('--path', '-p', type=Path, default=Path.cwd())
    build_p.add_argument('--verbose', '-v', action='store_true')
    build_p.add_argument('--jobs', '-j', type=int, default=multiprocessing.cpu_count())

    cmake_p = subparsers.add_parser('cmake')
    cmake_p.set_defaults(func=main_cmake)
    cmake_p.add_argument('--path', '-p', type=Path, default=Path.cwd())
    cmake_p.add_argument('--force', '-f', action='store_true')

    args = p.parse_args()
    if hasattr(args, 'func') and args.func is not None:
        args.func(args)
    else:
        p.print_help()
        exit(1)
